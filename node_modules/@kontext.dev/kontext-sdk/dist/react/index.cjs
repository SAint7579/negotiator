'use strict';var ue=require('react'),reactQuery$1=require('@tanstack/react-query'),reactQuery=require('@trpc/react-query'),client=require('@trpc/client'),J=require('superjson'),jsxRuntime=require('react/jsx-runtime');function _interopDefault(e){return e&&e.__esModule?e:{default:e}}var ue__default=/*#__PURE__*/_interopDefault(ue);var J__default=/*#__PURE__*/_interopDefault(J);function G(t,e){let o=e.startsWith("ktext");return client.createTRPCProxyClient({links:[client.httpBatchLink({url:`${t}/trpc`,transformer:J__default.default,maxItems:10,maxURLLength:2083,async headers(){return o?{"x-api-key":e}:{Authorization:`Bearer ${e}`}},fetch(n,a){return fetch(n,{...a,keepalive:true})}})]})}var O=class{constructor(e){if(!e.apiKey)throw new Error("Persona API key is required");this.config={apiKey:e.apiKey,providers:e.providers||["gmail","preferences"],apiUrl:e.apiUrl||"https://api.kontext.dev",cache:{ttl:e.cache?.ttl||300,storage:e.cache?.storage||"memory"},limits:{maxTokensPerRequest:e.limits?.maxTokensPerRequest||2e3,monthlyBudget:e.limits?.monthlyBudget||0}};}async getContext(e){if(!e)throw this.createError("GetContextOptions is required. Please provide an object with at least a userId field.","INVALID_OPTIONS",400);let{userId:o,task:n,maxTokens:a,privacyLevel:r}=e;if(!o||typeof o!="string")throw this.createError("Valid userId is required. Please provide a non-empty string userId.","INVALID_USER_ID",400);if(a!==void 0&&(typeof a!="number"||a<=0))throw this.createError("maxTokens must be a positive number if provided.","INVALID_MAX_TOKENS",400);if(r&&!["strict","moderate","none"].includes(r))throw this.createError("privacyLevel must be one of: strict, moderate, none","INVALID_PRIVACY_LEVEL",400);let c=G(this.config.apiUrl,this.config.apiKey);try{let d=await c.data.context.query({userId:o,task:n||"general",maxFacts:a?Math.min(a/10,100):void 0,cachePolicy:"fresh",includeRecentData:!0,privacyLevel:r||"none"});return {systemPrompt:d.systemPrompt,metadata:{userId:e.userId,timestamp:d.metadata?.generatedAt||new Date,providers:["gmail"]},tokenCount:d.systemPrompt.length/4}}catch(d){let p=d instanceof Error?d.message:"Failed to get context";throw p.includes("Invalid input")||p.includes("expected object")?this.createError("Invalid request format. This may be a SDK version mismatch with the API.","INVALID_REQUEST_FORMAT",400):p.includes("OAuth access")||p.includes("No OAuth")?this.createError("User has not authorized access. Please ensure the user has connected their account.","UNAUTHORIZED_USER",403):this.createError(p,"CONTEXT_FAILED",500)}}async disconnect(e){if(!e||typeof e!="string")throw this.createError("Valid userId is required for disconnect. Please provide a non-empty string userId.","INVALID_USER_ID",400);try{await G(this.config.apiUrl,this.config.apiKey).gdpr.deleteData.mutate({userId:e});}catch(o){let n=o instanceof Error?o.message:"Failed to disconnect";throw n.includes("not found")||n.includes("does not exist")?this.createError("User not found. The user may have already been disconnected.","USER_NOT_FOUND",404):this.createError(n,"DISCONNECT_FAILED",500)}}createError(e,o,n){let a=new Error(e);return a.name="PersonaError",a.code=o,a.statusCode=n,a}};var Q=reactQuery.createTRPCReact(),Y=ue.createContext(void 0),xe=1440*60*1e3;function X({apiKey:t,apiUrl:e,children:o}){let[n,a]=ue.useState(false),[r,c]=ue.useState(null),[d,p]=ue.useState(true),[g,h]=ue.useState(null),[b,C]=ue.useState(null),[s,E]=ue.useState(null),[S,f]=ue.useState(false),y=ue__default.default.useMemo(()=>t?new O({apiKey:t,apiUrl:e||"https://api.kontext.dev"}):null,[t,e]),i=s?Date.now()-s.getTime()>xe:true,P=ue.useCallback(async()=>{if(!(!r||!t)){f(true),h(null);try{if(!y)throw new Error("Persona client not initialized");let u=await y.getContext({userId:r,task:"chat",maxTokens:500});C(u.systemPrompt),E(new Date);}catch(u){console.debug("[Kontext SDK] Failed to fetch profile:",u);}finally{f(false);}}},[r,e,t,y]),A=ue.useCallback(async()=>{if(!t){p(false);return}try{let x=new URLSearchParams(window.location.search).get("user_id");if(x)c(x),a(!0),window.history.replaceState({},document.title,window.location.pathname),localStorage.setItem("persona_user_id",x);else {let w=localStorage.getItem("persona_user_id");w&&(c(w),a(!0));}}catch(u){console.debug("[Kontext SDK] Failed to check connection:",u);}finally{p(false);}},[t,P]);ue.useEffect(()=>{A();},[]),ue.useEffect(()=>{r&&n&&!b&&P();},[r,n,b,P]);let m=async()=>{if(!e||!t){let u="API URL and API key required for Gmail connection";throw h(u),new Error(u)}try{let u=new URL(window.location.href),x=`${u.origin}${u.pathname}`;if(!x.startsWith(window.location.origin))throw new Error("Invalid redirect URI - must be from the same origin");let w=await fetch(`${e}/oauth/gmail?redirect_uri=${encodeURIComponent(x)}`,{method:"GET",headers:{"x-api-key":t}}).catch(U=>{throw console.debug("[Kontext SDK] Network error during OAuth:",U),new Error("Network error. Please check your connection and try again.")});if(w.ok){let U=await w.json().catch(()=>null);if(U?.authUrl)window.location.href=U.authUrl;else throw new Error("No authorization URL received from server")}else {let U=await w.json().catch(()=>({error:{message:"Failed to initiate OAuth"}}));throw new Error(U.error?.message||"Failed to initiate OAuth")}}catch(u){let x=u instanceof Error?u.message:"Failed to initiate Gmail connection";throw console.debug("[Kontext SDK] Failed to initiate Gmail connection:",u),h(x),u}},K=async()=>{if(!r||!y){let u="Must be connected to disconnect";throw h(u),new Error(u)}try{await y.disconnect(r);}catch(u){console.debug("[Kontext SDK] Failed to disconnect:",u);}finally{c(null),a(false),C(null),E(null),h(null),localStorage.removeItem("persona_user_id");}},L=ue.useCallback(async()=>{if(!n||!r)throw new Error("User must be connected to refresh profile");await P();},[n,r,P]),N={apiKey:t,isConnected:n,userId:r,isLoading:d,error:g,connectGmail:m,disconnect:K,systemPrompt:b,profileLastUpdated:s,isProfileStale:i,isRefreshingProfile:S,refreshProfile:L,trpc:Q};return jsxRuntime.jsx(Y.Provider,{value:N,children:o})}function be({apiKey:t,apiUrl:e="https://api.kontext.dev",children:o}){let[n]=ue.useState(()=>new reactQuery$1.QueryClient({defaultOptions:{queries:{staleTime:6e5,gcTime:18e5,retry:(r,c)=>{let d=c;return d?.status&&d.status>=400&&d.status<500?false:r<3},refetchOnWindowFocus:false,refetchOnReconnect:true},mutations:{retry:1}}})),[a]=ue.useState(()=>t?Q.createClient({transformer:J__default.default,links:[client.httpBatchLink({url:`${e}/trpc`,maxItems:10,maxURLLength:2083,async headers(){return {"x-api-key":t}},fetch(r,c){return fetch(r,{...c,keepalive:true})}})]}):null);return a?jsxRuntime.jsx(Q.Provider,{client:a,queryClient:n,children:jsxRuntime.jsx(reactQuery$1.QueryClientProvider,{client:n,children:jsxRuntime.jsx(X,{apiKey:t,apiUrl:e,children:o})})}):jsxRuntime.jsx(reactQuery$1.QueryClientProvider,{client:n,children:jsxRuntime.jsx(X,{apiKey:t,apiUrl:e,children:o})})}function T(){let t=ue.useContext(Y);if(!t)throw new Error("useKontext must be used within KontextProvider");return t}function Ce(){let t=T();return {systemPrompt:t.systemPrompt,lastUpdated:t.profileLastUpdated,isStale:t.isProfileStale,isRefreshing:t.isRefreshingProfile,refresh:t.refreshProfile}}function Re(t={}){let{userId:e,apiKey:o}=T(),n=reactQuery$1.useQueryClient(),[a,r]=ue.useState({isConnected:false,lastUpdate:null,updateCount:0,recentUpdates:[]}),{enabled:c=true,onUpdate:d}=t,p=ue.useRef(d);p.current=d;let g=ue.useRef(true);return ue.useEffect(()=>{if(g.current=true,!c||!e||!o)return;let h=false,b=process.env.NEXT_PUBLIC_KONTEXT_API_URL||"https://api.kontext.dev",C=b.replace("https://","wss://").replace("http://","ws://"),s=client.createWSClient({url:`${C}/trpc`,connectionParams:async()=>({"x-api-key":o})}),E=client.createTRPCClient({links:[client.splitLink({condition:f=>f.type==="subscription",true:client.wsLink({client:s,transformer:J__default.default}),false:client.httpBatchLink({url:`${b}/trpc`,headers:{"x-api-key":o},transformer:J__default.default})})]}),S;try{S=E.data.contextUpdates.subscribe({userId:e},{onData:f=>{h||!g.current||(console.log("Received context update:",f),r(y=>({isConnected:!0,lastUpdate:new Date,updateCount:y.updateCount+1,recentUpdates:[{type:f.type||"unknown",timestamp:f.timestamp?new Date(f.timestamp):new Date,metadata:f.metadata||{}},...y.recentUpdates.slice(0,9)]})),n.invalidateQueries({queryKey:["context",e]}),p.current&&p.current(f));},onError:f=>{h||!g.current||(console.error("Subscription error:",f),r(y=>({...y,isConnected:!1})));}});}catch(f){console.error("Failed to create subscription:",f);return}return !h&&g.current&&r(f=>({...f,isConnected:true})),()=>{h=true,g.current=false,S&&S.unsubscribe(),s.close();}},[c,e,o,n]),a}function Te(t=3e4){let{userId:e,isConnected:o}=T(),n=reactQuery$1.useQueryClient(),[a,r]=ue.useState(false);return ue.useEffect(()=>{if(!o||!e)return;r(true);let c=setInterval(()=>{n.invalidateQueries({queryKey:["context",e]});},t);return ()=>{r(false),clearInterval(c);}},[o,e,t,n]),{isPolling:a}}function oe(t={}){let{initialTheme:e="light",onThemeChange:o}=t,[n,a]=ue.useState(e),r=ue.useRef(null),c=ue.useRef(null),d=ue.useRef(null),p=ue.useRef(o);return p.current=o,ue.useEffect(()=>{let g=()=>{let s=document.documentElement.classList.contains("dark")||document.body.classList.contains("dark")||window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light";a(s),p.current?.(s);};d.current=g,g();let h=new MutationObserver(g);r.current=h,h.observe(document.documentElement,{attributes:true,attributeFilter:["class"]});let b=window.matchMedia("(prefers-color-scheme: dark)");return c.current=b,b.addEventListener("change",g),()=>{r.current&&(r.current.disconnect(),r.current=null),c.current&&d.current&&(c.current.removeEventListener("change",d.current),c.current=null),d.current=null;}},[]),n}var _={light:{background:"#ffffff",foreground:"#0a0a0a",card:"#ffffff",cardForeground:"#0a0a0a",popover:"#ffffff",popoverForeground:"#0a0a0a",primary:"#0066cc",primaryForeground:"#ffffff",secondary:"#fafafa",secondaryForeground:"#0a0a0a",muted:"#f5f5f5",mutedForeground:"#666666",accent:"#f5f5f5",accentForeground:"#0a0a0a",destructive:"#dc2626",destructiveForeground:"#ffffff",border:"#f0f0f0",input:"#f0f0f0",ring:"#0066cc",success:"#22c55e",successForeground:"#ffffff",warning:"#f59e0b",zinc:"#71717a",forestGreen:"#16a34a"},dark:{background:"#0a0a0a",foreground:"#f5f5f5",card:"#0a0a0a",cardForeground:"#f5f5f5",popover:"#0a0a0a",popoverForeground:"#f5f5f5",primary:"#4d94ff",primaryForeground:"#0a0a0a",secondary:"#1a1a1a",secondaryForeground:"#f5f5f5",muted:"#1a1a1a",mutedForeground:"#999999",accent:"#1a1a1a",accentForeground:"#f5f5f5",destructive:"#ef4444",destructiveForeground:"#f5f5f5",border:"#262626",input:"#262626",ring:"#4d94ff",success:"#22c55e",successForeground:"#0a0a0a",warning:"#f59e0b",zinc:"#a1a1aa",forestGreen:"#22c55e"}},l={fontSans:"-apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif",fontSize:{xs:"0.75rem",sm:"0.875rem",base:"1rem"},fontWeight:{normal:400,medium:500,semibold:600}},v={1:"0.25rem",2:"0.5rem",3:"0.75rem",4:"1rem"},I={base:"0.375rem",lg:"0.75rem",full:"9999px"},z={fast:"all 150ms ease"},F={low:"0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 2px rgba(0, 0, 0, 0.04)",lowDark:"0 2px 8px rgba(0, 0, 0, 0.32), 0 1px 2px rgba(0, 0, 0, 0.24)"};var ne={sm:{height:"2rem",padding:"0 0.75rem",fontSize:l.fontSize.sm,gap:"0.375rem"},default:{height:"2.25rem",padding:"0 1rem",fontSize:l.fontSize.sm,gap:"0.5rem"},lg:{height:"2.5rem",padding:"0 1.5rem",fontSize:l.fontSize.base,gap:"0.5rem"}};function se({className:t="",children:e="Connect Gmail",variant:o="default",size:n="default",fullWidth:a=false,onError:r}){let{connectGmail:c,isConnected:d,isLoading:p}=T(),g=oe(),[h,b]=ue.useState(false),[C,s]=ue.useState(false),[E,S]=ue.useState(null),[f,y]=ue.useState(false),i=_[g];if(d)return null;let P=async()=>{s(true),S(null),y(false);try{await c();}catch(x){console.debug("[KontextConnectButton] Connection error caught:",x);let w="Unable to connect. Please try again.";S(w),y(true),r&&r(w),setTimeout(()=>y(false),5e3);}finally{s(false);}},m=(()=>{let x={default:{backgroundColor:i.primary,color:i.primaryForeground,border:"none"},secondary:{backgroundColor:i.secondary,color:i.secondaryForeground,border:"none"},outline:{backgroundColor:"transparent",color:i.foreground,border:`1px solid ${i.border}`},ghost:{backgroundColor:"transparent",color:i.foreground,border:"none"},success:{backgroundColor:i.success,color:i.successForeground,border:"none"}},w={default:{backgroundColor:i.primary,opacity:.9},secondary:{backgroundColor:i.secondary,opacity:.8},outline:{backgroundColor:i.accent},ghost:{backgroundColor:i.accent},success:{backgroundColor:i.success,opacity:.9}};return {base:x[o],hover:w[o]}})(),K=ne[n],L={fontFamily:l.fontSans,fontWeight:l.fontWeight.medium,borderRadius:I.lg,transition:z.fast,cursor:C||p?"not-allowed":"pointer",display:"inline-flex",alignItems:"center",justifyContent:"center",whiteSpace:"nowrap",outline:"none",position:"relative",width:a?"100%":"auto",...K,...m.base,border:"none",boxShadow:`
      0 0 0 1px ${i.forestGreen},
      0 0 0 2px ${i.zinc},
      ${g==="dark"?F.lowDark:F.low}
    `,...h&&!C&&!p?m.hover:{},opacity:C||p?.5:h&&"opacity"in m.hover?m.hover.opacity:1},N=()=>jsxRuntime.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",style:{animation:"spin 1s linear infinite"},children:jsxRuntime.jsxs("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none",strokeDasharray:"32",strokeDashoffset:"32",children:[jsxRuntime.jsx("animate",{attributeName:"stroke-dasharray",dur:"2s",values:"0 32;16 16;0 32;0 32",repeatCount:"indefinite"}),jsxRuntime.jsx("animate",{attributeName:"stroke-dashoffset",dur:"2s",values:"0;-16;-32;-32",repeatCount:"indefinite"})]})}),u={position:"absolute",bottom:"100%",left:"50%",transform:"translateX(-50%)",marginBottom:v[2],backgroundColor:i.destructive,color:i.destructiveForeground,padding:`${v[1]} ${v[2]}`,borderRadius:I.base,fontSize:l.fontSize.xs,fontFamily:l.fontSans,whiteSpace:"nowrap",opacity:f?1:0,pointerEvents:"none",transition:z.fast,zIndex:10};return jsxRuntime.jsxs(jsxRuntime.Fragment,{children:[jsxRuntime.jsxs("div",{style:{position:"relative",display:"inline-block",width:a?"100%":"auto"},children:[f&&E&&jsxRuntime.jsx("div",{style:u,children:E}),jsxRuntime.jsx("button",{onClick:P,disabled:C||p,className:t,style:L,onMouseEnter:()=>b(true),onMouseLeave:()=>b(false),onFocus:x=>{x.currentTarget.style.boxShadow=`
              0 0 0 1px ${i.forestGreen},
              0 0 0 2px ${i.zinc},
              0 0 0 5px ${i.ring},
              ${g==="dark"?F.lowDark:F.low}
            `;},onBlur:x=>{x.currentTarget.style.boxShadow=`
              0 0 0 1px ${i.forestGreen},
              0 0 0 2px ${i.zinc},
              ${g==="dark"?F.lowDark:F.low}
            `;},children:C||p?jsxRuntime.jsxs("span",{style:{display:"flex",alignItems:"center",gap:v[2]},children:[jsxRuntime.jsx(N,{}),"Connecting..."]}):e})]}),jsxRuntime.jsx("style",{children:`
        @keyframes spin {
          from { transform: rotate(0deg); }
          to { transform: rotate(360deg); }
        }
      `})]})}function ie({className:t="",connectedText:e="Personalized responses enabled",disconnectedText:o="Connect Gmail for personalized responses",showDisconnect:n=false,disconnectClassName:a="",variant:r="inline"}){let{isConnected:c,isLoading:d,disconnect:p}=T(),[g,h]=ue.useState("light"),[b,C]=ue.useState(false);ue.useEffect(()=>{let m=()=>{let N=document.documentElement.classList.contains("dark")||document.body.classList.contains("dark")||window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches;h(N?"dark":"light");};m();let K=new MutationObserver(m);K.observe(document.documentElement,{attributes:true,attributeFilter:["class"]});let L=window.matchMedia("(prefers-color-scheme: dark)");return L.addEventListener("change",m),()=>{K.disconnect(),L.removeEventListener("change",m);}},[]);let s=_[g],S=(()=>{let m={fontFamily:l.fontSans,fontSize:l.fontSize.sm,display:"flex",alignItems:"center",gap:v[2]};switch(r){case "card":return {...m,backgroundColor:s.card,color:s.cardForeground,border:`1px solid ${s.border}`,borderRadius:I.lg,padding:v[4],boxShadow:"none"};case "badge":return {...m,backgroundColor:c?s.success:s.muted,color:c?s.successForeground:s.mutedForeground,borderRadius:I.full,padding:`${v[1]} ${v[3]}`,fontSize:l.fontSize.xs,fontWeight:l.fontWeight.medium,display:"inline-flex"};case "inline":default:return {...m,color:s.foreground}}})(),f={color:s.mutedForeground,fontFamily:l.fontSans,fontSize:l.fontSize.sm,display:"flex",alignItems:"center",gap:v[2]},y={color:s.success,fontWeight:l.fontWeight.semibold,fontSize:r==="badge"?l.fontSize.xs:l.fontSize.sm},i={color:c?r==="badge"?s.successForeground:s.success:s.mutedForeground,fontWeight:r==="badge"?l.fontWeight.medium:l.fontWeight.normal},P={marginLeft:v[2],backgroundColor:b?s.accent:"transparent",color:s.destructive,fontWeight:l.fontWeight.medium,padding:`${v[1]} ${v[2]}`,borderRadius:I.base,border:`1px solid ${s.destructive}`,cursor:"pointer",transition:z.fast,fontFamily:l.fontSans,fontSize:l.fontSize.xs,outline:"none"},A=()=>jsxRuntime.jsx("svg",{width:"14",height:"14",viewBox:"0 0 24 24",style:{animation:"spin 1s linear infinite",color:s.mutedForeground},children:jsxRuntime.jsxs("circle",{cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4",fill:"none",strokeDasharray:"32",strokeDashoffset:"32",children:[jsxRuntime.jsx("animate",{attributeName:"stroke-dasharray",dur:"2s",values:"0 32;16 16;0 32;0 32",repeatCount:"indefinite"}),jsxRuntime.jsx("animate",{attributeName:"stroke-dashoffset",dur:"2s",values:"0;-16;-32;-32",repeatCount:"indefinite"})]})});return d?jsxRuntime.jsxs(jsxRuntime.Fragment,{children:[jsxRuntime.jsxs("div",{className:t,style:{...S,...f},children:[jsxRuntime.jsx(A,{}),jsxRuntime.jsx("span",{children:"Loading..."})]}),jsxRuntime.jsx("style",{children:`
          @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
          }
        `})]}):c?jsxRuntime.jsxs("div",{className:t,style:S,children:[jsxRuntime.jsx("span",{style:y,children:"\u2713"}),jsxRuntime.jsx("span",{style:i,children:e}),n&&jsxRuntime.jsx("button",{onClick:p,className:a,style:P,onMouseEnter:()=>C(true),onMouseLeave:()=>C(false),onFocus:m=>{m.currentTarget.style.outline=`2px solid ${s.ring}`,m.currentTarget.style.outlineOffset="2px";},onBlur:m=>{m.currentTarget.style.outline="none";},children:"Disconnect"})]}):jsxRuntime.jsx("div",{className:t,style:S,children:jsxRuntime.jsx("span",{style:i,children:o})})}exports.KontextConnectButton=se;exports.KontextProvider=be;exports.KontextStatus=ie;exports.useKontext=T;exports.useKontextProfile=Ce;exports.usePollingContext=Te;exports.useRealtimeContext=Re;//# sourceMappingURL=index.cjs.map
//# sourceMappingURL=index.cjs.map