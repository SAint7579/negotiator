'use strict';var client=require('@trpc/client'),u=require('superjson');function _interopDefault(e){return e&&e.__esModule?e:{default:e}}var u__default=/*#__PURE__*/_interopDefault(u);function c(d,e){let r=e.startsWith("ktext");return client.createTRPCProxyClient({links:[client.httpBatchLink({url:`${d}/trpc`,transformer:u__default.default,maxItems:10,maxURLLength:2083,async headers(){return r?{"x-api-key":e}:{Authorization:`Bearer ${e}`}},fetch(o,t){return fetch(o,{...t,keepalive:true})}})]})}var a=class{constructor(e){if(!e.apiKey)throw new Error("Persona API key is required");this.config={apiKey:e.apiKey,providers:e.providers||["gmail","preferences"],apiUrl:e.apiUrl||"https://api.kontext.dev",cache:{ttl:e.cache?.ttl||300,storage:e.cache?.storage||"memory"},limits:{maxTokensPerRequest:e.limits?.maxTokensPerRequest||2e3,monthlyBudget:e.limits?.monthlyBudget||0}};}async getContext(e){if(!e)throw this.createError("GetContextOptions is required. Please provide an object with at least a userId field.","INVALID_OPTIONS",400);let{userId:r,task:o,maxTokens:t,privacyLevel:i}=e;if(!r||typeof r!="string")throw this.createError("Valid userId is required. Please provide a non-empty string userId.","INVALID_USER_ID",400);if(t!==void 0&&(typeof t!="number"||t<=0))throw this.createError("maxTokens must be a positive number if provided.","INVALID_MAX_TOKENS",400);if(i&&!["strict","moderate","none"].includes(i))throw this.createError("privacyLevel must be one of: strict, moderate, none","INVALID_PRIVACY_LEVEL",400);let p=c(this.config.apiUrl,this.config.apiKey);try{let s=await p.data.context.query({userId:r,task:o||"general",maxFacts:t?Math.min(t/10,100):void 0,cachePolicy:"fresh",includeRecentData:!0,privacyLevel:i||"none"});return {systemPrompt:s.systemPrompt,metadata:{userId:e.userId,timestamp:s.metadata?.generatedAt||new Date,providers:["gmail"]},tokenCount:s.systemPrompt.length/4}}catch(s){let n=s instanceof Error?s.message:"Failed to get context";throw n.includes("Invalid input")||n.includes("expected object")?this.createError("Invalid request format. This may be a SDK version mismatch with the API.","INVALID_REQUEST_FORMAT",400):n.includes("OAuth access")||n.includes("No OAuth")?this.createError("User has not authorized access. Please ensure the user has connected their account.","UNAUTHORIZED_USER",403):this.createError(n,"CONTEXT_FAILED",500)}}async disconnect(e){if(!e||typeof e!="string")throw this.createError("Valid userId is required for disconnect. Please provide a non-empty string userId.","INVALID_USER_ID",400);try{await c(this.config.apiUrl,this.config.apiKey).gdpr.deleteData.mutate({userId:e});}catch(r){let o=r instanceof Error?r.message:"Failed to disconnect";throw o.includes("not found")||o.includes("does not exist")?this.createError("User not found. The user may have already been disconnected.","USER_NOT_FOUND",404):this.createError(o,"DISCONNECT_FAILED",500)}}createError(e,r,o){let t=new Error(e);return t.name="PersonaError",t.code=r,t.statusCode=o,t}};
exports.Persona=a;//# sourceMappingURL=index.cjs.map
//# sourceMappingURL=index.cjs.map