# Kontext SDK

AI personalization through user context.

## Installation

```bash
npm install @kontext.dev/kontext-sdk
```

## Quick Start

### React (Client-Side)

```tsx
import { KontextProvider, useKontext } from '@kontext.dev/kontext-sdk/react';

// 1. Wrap your app
function App() {
  return (
    <KontextProvider apiKey={process.env.NEXT_PUBLIC_KONTEXT_API_KEY}>
      <YourApp />
    </KontextProvider>
  );
}

// 2. Connect Gmail (one-time)
function ConnectButton() {
  const { isConnected, connectGmail } = useKontext();

  if (isConnected) return null;
  return <button onClick={connectGmail}>Connect Gmail</button>;
}
```

### Next.js App Router Integration

**Important**: `useKontext()` is client-side only. Pass `userId` to your server:

```tsx
// app/components/chat-provider.tsx
'use client';
import { useKontext } from '@kontext.dev/kontext-sdk/react';
import { useEffect } from 'react';

export function ChatProvider({ children }) {
  const { userId, isConnected } = useKontext();

  // Option 1: Use cookies (recommended)
  useEffect(() => {
    if (userId && isConnected) {
      document.cookie = `kontext_user_id=${userId}; path=/; max-age=86400`;
    }
  }, [userId, isConnected]);

  return <>{children}</>;
}

// app/api/chat/route.ts
import { cookies } from 'next/headers';
import { Persona } from '@kontext.dev/kontext-sdk';

export async function POST(req: Request) {
  const { message } = await req.json();
  const cookieStore = await cookies();
  const userId = cookieStore.get('kontext_user_id')?.value;

  if (!userId) {
    return Response.json({ error: 'User not connected' }, { status: 401 });
  }

  // Get fresh context
  const persona = new Persona({ apiKey: process.env.KONTEXT_API_KEY });
  const context = await persona.getContext({ userId, task: 'chat' });

  // Use with your AI (OpenAI, Anthropic, etc.)
  const response = await openai.chat.completions.create({
    model: 'gpt-4',
    messages: [
      { role: 'system', content: context.systemPrompt },
      { role: 'user', content: message }
    ]
  });

  return Response.json({ response: response.choices[0].message.content });
}
```

### Integration Examples

#### Vercel AI SDK
```typescript
import { streamText } from 'ai';
import { openai } from '@ai-sdk/openai';

// In your API route
const context = await persona.getContext({ userId, task: 'chat' });

const result = streamText({
  model: openai('gpt-4'),
  system: context.systemPrompt,
  messages: convertToCoreMessages(messages),
});
```

#### Anthropic Claude
```typescript
import Anthropic from '@anthropic-ai/sdk';

const context = await persona.getContext({ userId, task: 'chat' });

const message = await anthropic.messages.create({
  model: 'claude-3-opus-20240229',
  system: context.systemPrompt,
  messages: [{ role: 'user', content: userMessage }]
});
```

## How It Works

1. **Connect**: User authorizes Gmail access once
2. **Process**: Kontext extracts facts from emails in the background
3. **Fetch**: Call `getContext()` to get fresh personalized context
4. **Enhance**: Add context to your AI calls for personalized responses

## Important: Client vs Server

- **KontextProvider & useKontext**: Client-side only (React components)
- **Persona.getContext()**: Server-side (API routes, server actions)
- **userId**: Must be passed from client to server (via cookies, headers, or request body)

## API

### Persona Class (Server-Side)

```typescript
const persona = new Persona({
  apiKey: string,              // Required
  apiUrl?: string,             // Default: 'https://api.kontext.dev'
  cache?: {
    ttl?: number,              // Cache TTL in seconds
    storage?: 'memory' | 'redis'
  }
})
```

### getContext()

Fetches fresh personalized context. Call this before each AI interaction or when you need updated context.

```typescript
const context = await persona.getContext({
  userId: string,              // Required: User's ID
  task: string,                // Required: Context purpose ('chat', 'support', 'email')
  maxTokens?: number,          // Limit context size
  privacyLevel?: 'strict' | 'moderate' | 'none'
})

// Returns
{
  systemPrompt: string,        // Ready-to-use context for AI
  metadata: {
    userId: string,
    timestamp: Date,
    providers: string[]
  },
  tokenCount: number
}
```

### disconnect()

Delete user data (GDPR compliance).

```typescript
await persona.disconnect(userId);
```

## React Hooks (Client-Side)

### useKontext()

Main hook for authentication and state. **Client-side only**.

```typescript
const {
  // State
  isConnected: boolean,        // User has authorized Gmail
  userId: string | null,       // Connected user's ID
  isLoading: boolean,
  error: string | null,

  // Actions
  connectGmail: () => void,    // Start OAuth flow
  disconnect: () => void,      // Delete user data

  // Cached context (24hr TTL)
  systemPrompt: string | null,
  refreshProfile: () => Promise<void>
} = useKontext()
```

### useKontextProfile()

Access cached profile data.

```typescript
const {
  systemPrompt: string | null,
  lastUpdated: Date | null,
  isStale: boolean,            // >24 hours old
  refresh: () => Promise<void>
} = useKontextProfile()
```

## Components

### KontextConnectButton

OAuth button with built-in styling.

```tsx
import { KontextConnectButton } from '@kontext.dev/kontext-sdk/components';

<KontextConnectButton
  variant="default" // 'default' | 'outline' | 'ghost'
  size="default" // 'sm' | 'default' | 'lg'
/>;
```

### KontextStatus

Connection status indicator.

```tsx
import { KontextStatus } from '@kontext.dev/kontext-sdk/components';

<KontextStatus />;
```

## Real Example

```tsx
function CustomerSupport() {
  const { isConnected, connectGmail, userId } = useKontext();
  const [messages, setMessages] = useState([]);

  const handleMessage = async (userInput: string) => {
    // Get fresh context for this interaction
    const persona = new Persona({ apiKey: process.env.KONTEXT_API_KEY });
    const { systemPrompt } = await persona.getContext({
      userId,
      task: 'support', // Optimize context for support
    });

    // Call your AI with personalized context
    const response = await callYourAI({
      system: systemPrompt,
      messages: [...messages, { role: 'user', content: userInput }],
    });

    setMessages([
      ...messages,
      { role: 'user', content: userInput },
      { role: 'assistant', content: response },
    ]);
  };

  if (!isConnected) {
    return <button onClick={connectGmail}>Enable Personalization</button>;
  }

  return <YourChatUI onMessage={handleMessage} />;
}
```

## Environment Variables

```bash
# Required
KONTEXT_API_KEY=pk_live_xxxxx

# For React/Next.js
NEXT_PUBLIC_KONTEXT_API_KEY=pk_live_xxxxx
```

## TypeScript

Full TypeScript support included.

```typescript
import type {
  PersonaConfig,
  GetContextOptions,
  Context,
  PersonaError,
  KontextProviderProps,
} from '@kontext.dev/kontext-sdk';
```

## Troubleshooting

### Common Issues

#### userId not reaching server
- **Issue**: `userId` is available on client but not on server
- **Solution**: Use cookies (shown above) or pass via headers/body
- **Debug**: `console.log('userId:', userId)` on both client and server

#### "UNAUTHORIZED_USER" error
- **Issue**: User hasn't connected Gmail yet
- **Solution**: Check `isConnected` before calling `getContext()`
```typescript
if (!userId || !isConnected) {
  return { error: 'Please connect Gmail first' };
}
```

#### Context not being used
- **Issue**: System prompt not added to AI messages
- **Solution**: Ensure you prepend `systemPrompt` to your message array
```typescript
// ✅ Correct
messages: [
  { role: 'system', content: context.systemPrompt },
  ...userMessages
]

// ❌ Wrong - context not used
messages: userMessages
```

### Debugging

Enable logging to verify integration:
```typescript
const context = await persona.getContext({ userId, task: 'chat' });
console.log('Context loaded:', {
  userId,
  hasContext: !!context.systemPrompt,
  tokenCount: context.tokenCount,
  preview: context.systemPrompt.substring(0, 100) + '...'
});
```

## Error Handling

```typescript
try {
  const context = await persona.getContext({ userId, task: 'chat' });
} catch (error) {
  if (error.code === 'UNAUTHORIZED_USER') {
    // User needs to connect Gmail
  } else if (error.code === 'INVALID_USER_ID') {
    // Invalid user ID
  } else if (error.code === 'RATE_LIMITED') {
    // Too many requests
  }
}
```

## Advanced

### Task Types

Optimize context for different use cases:

- `'chat'` - General conversation
- `'support'` - Customer support
- `'email'` - Email writing
- `'sales'` - Sales interactions

### Privacy Levels

Control PII handling:

- `'strict'` - Redact personal info
- `'moderate'` - Balanced (default)
- `'none'` - Full access

### Real-time Updates

```typescript
import { useRealtimeContext } from '@kontext.dev/kontext-sdk/react';

const { isConnected, lastUpdate } = useRealtimeContext({
  enabled: true,
  onUpdate: (event) => console.log('Context updated'),
});
```

## License

MIT
